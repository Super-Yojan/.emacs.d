#+TITLE: Minimal Emacs Configuration (Stable Org Version)
#+AUTHOR: Yojan Gautam
#+EMAIL: gautamyojan0@gmail.com
#+OPTIONS: num:nil toc:nil
#+PROPERTY: header-args:emacs-lisp :tangle init.el

* Introduction
A minimal, focused Emacs configuration using **built-in org-mode** for maximum stability.

** Key Differences from Custom Org Version:
- Uses Emacs built-in org-mode (stable, no installation issues)
- org-fragtog for LaTeX preview (simpler than org-latex-preview)
- All other features remain the same
- LSP support in org-mode source blocks included

** Setup Instructions
1. Save this file as =~/.emacs.d/init.org=
2. Run =M-x org-babel-tangle=
3. Restart Emacs

* Early Initialization
#+begin_src emacs-lisp :tangle early-init.el
;; -*- lexical-binding: t; -*-

;; Garbage Collection - More conservative initial setting
(setq gc-cons-threshold (* 50 1024 1024))
(add-hook 'emacs-startup-hook
          (lambda () (setq gc-cons-threshold (* 20 1024 1024))))

;; Disable UI Elements
(setq default-frame-alist
      '((tool-bar-lines . 0)
        (menu-bar-lines . 0)
        (vertical-scroll-bars . nil)))
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Inhibit Startup
(setq inhibit-startup-message t
      inhibit-splash-screen t
      initial-scratch-message nil)

;; Native compilation warnings
(setq native-comp-async-report-warnings-errors nil)
#+end_src

* Core Setup
#+begin_src emacs-lisp
;; -*- lexical-binding: t -*-

;; Ensure seq is loaded early (fixes seq-empty-p error with Evil)
(require 'seq)

;; Bootstrap straight.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 7))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; Use-package with straight
(straight-use-package 'use-package)
(setq straight-use-package-by-default t)

;; Prevent straight from managing built-in packages INCLUDING org
(setq straight-built-in-pseudo-packages '(emacs nadvice python eldoc project org))

;; Use built-in org-mode (stable and always works)
(require 'org)
(require 'org-tempo)

;; Basic settings
(setq-default
 ring-bell-function 'ignore
 column-number-mode t
 indent-tabs-mode nil
 tab-width 4
 fill-column 80)

(show-paren-mode 1)
(delete-selection-mode 1)
(global-auto-revert-mode 1)

;; Recent files tracking
(recentf-mode 1)
(setq recentf-max-saved-items 100
      recentf-max-menu-items 15
      recentf-auto-cleanup 'never)
(run-at-time nil (* 5 60) 'recentf-save-list)

;; Backup settings with error handling
(let ((backup-dir (expand-file-name ".cache/backups" user-emacs-directory))
      (auto-save-dir (expand-file-name ".cache/auto-save" user-emacs-directory)))
  (condition-case err
      (progn
        (make-directory backup-dir t)
        (make-directory auto-save-dir t)
        (setq backup-directory-alist `(("." . ,backup-dir))
              auto-save-file-name-transforms `((".*" ,auto-save-dir t))
              backup-by-copying t
              delete-old-versions t
              kept-new-versions 6
              kept-old-versions 2
              version-control t
              create-lockfiles nil))
    (error
     (warn "Failed to create backup directories: %s" err))))

(use-package exec-path-from-shell
  :ensure t
  :config
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize)))

#+end_src

** Reload Function
#+begin_src emacs-lisp
(defun my-reload-init-file ()
  "Reloads the user's Emacs initialization file."
  (interactive)
  (load-file user-init-file)
  (message "Emacs init file reloaded!"))
#+end_src

* UI Enhancements
#+begin_src emacs-lisp
;; Set font with error handling
(condition-case err
    (set-face-attribute 'default nil :font "FiraCode Nerd Font Mono-14")
  (error
   (warn "FiraCode Nerd Font not found, using default font: %s" err)))

(use-package visual-fill-column
  :ensure t)

;; Theme toggle function
(defun toggle-human-aug-theme ()
  "Switch between Human Augmentation Dark and Light themes."
  (interactive)
  (if (custom-theme-enabled-p 'human-aug)
      (progn
        (disable-theme 'human-aug)
        (load-theme 'human-aug-light t)
        (message "Switched to Light Mode"))
    (progn
      (disable-theme 'human-aug-light)
      (load-theme 'human-aug t)
      (message "Switched to Dark Mode"))))

;; Bind the toggle to F5 key
(global-set-key (kbd "<f5>") 'toggle-human-aug-theme)

;; Load theme with error handling
(let ((theme-dir "~/.emacs.d/themes/"))
  (when (file-directory-p theme-dir)
    (add-to-list 'custom-theme-load-path theme-dir)
    (condition-case err
        (load-theme 'human-aug t)
      (error
       (warn "Failed to load human-aug theme: %s" err)))))

(use-package neotree
  :ensure t)

;; Undo-tree configuration with history directory
(use-package undo-tree
  :config
  (let ((undo-dir (concat user-emacs-directory "undo-tree-hist/")))
    (unless (file-exists-p undo-dir)
      (make-directory undo-dir t))
    (setq undo-tree-history-directory-alist `(("." . ,undo-dir))))
  (global-undo-tree-mode))

;; Icons for dashboard (optional, only if display supports it)
(use-package all-the-icons
  :if (display-graphic-p)
  :config
  (unless (member "all-the-icons" (font-family-list))
    (when (yes-or-no-p "Install all-the-icons fonts?")
      (all-the-icons-install-fonts t))))

(use-package org-auto-tangle
  :ensure t)

;; Dashboard for quick access
(use-package dashboard
  :config
  (dashboard-setup-startup-hook)
  (setq dashboard-startup-banner 'logo
        dashboard-center-content t
        dashboard-set-heading-icons t
        dashboard-set-file-icons t
        dashboard-items '((recents  . 5)
                          (projects . 10)
                          (bookmarks . 5))
        dashboard-set-init-info t
        dashboard-set-footer nil
        dashboard-week-agenda t)

  ;; Only set counsel-projectile if it's available
  (with-eval-after-load 'counsel-projectile
    (setq dashboard-projects-switch-function 'counsel-projectile-switch-project-by-name))
  
  (defun dashboard-goto-projects ()
    "Jump to projects section in dashboard."
    (interactive)
    (dashboard-refresh-buffer)
    (goto-char (point-min))
    (search-forward "Projects:" nil t))
  
  (defun dashboard-goto-recent-files ()
    "Jump to recent files section in dashboard."
    (interactive)
    (dashboard-refresh-buffer)
    (goto-char (point-min))
    (search-forward "Recent Files:" nil t)))

;; Line numbers
(setq display-line-numbers-type 'relative)
(global-display-line-numbers-mode t)
(dolist (mode '(org-mode-hook vterm-mode-hook term-mode-hook shell-mode-hook
                              pdf-view-mode-hook eshell-mode-hook
                              compilation-mode-hook dashboard-mode-hook))
  (add-hook mode (lambda () (display-line-numbers-mode -1))))

;; Fullscreen support
(defun toggle-fullscreen ()
  "Toggle fullscreen mode."
  (interactive)
  (set-frame-parameter nil 'fullscreen
                       (if (frame-parameter nil 'fullscreen) nil 'fullboth)))

;; Start in fullscreen (optional - uncomment if you want)
;; (add-hook 'emacs-startup-hook 'toggle-fullscreen)

;; Keybinding for fullscreen
(global-set-key (kbd "<f11>") 'toggle-fullscreen)

;; Zen Mode - Distraction-free writing
(use-package writeroom-mode
  :ensure t
  :config
  (setq writeroom-width 100                    ; Width of writing area
        writeroom-mode-line t                  ; Keep modeline
        writeroom-bottom-divider-width 0       ; No bottom divider
        writeroom-fullscreen-effect 'maximized ; Maximize instead of fullscreen
        writeroom-maximize-window t            ; Maximize the window
        writeroom-global-effects               ; Effects when entering zen mode
        '(writeroom-set-alpha                  ; Transparency
          writeroom-set-menu-bar-lines
          writeroom-set-tool-bar-lines
          writeroom-set-vertical-scroll-bars
          writeroom-set-bottom-divider-width))
  
  ;; Optional: center text with extra line spacing
  (setq writeroom-extra-line-spacing 0.2))

;; Alternative: olivetti mode (lighter weight zen mode)
(use-package olivetti
  :ensure t
  :config
  (setq olivetti-body-width 100))  ; Width of text area

;; Function to toggle zen mode with multiple options
(defun my-zen-mode ()
  "Toggle zen mode for distraction-free writing."
  (interactive)
  (if (bound-and-true-p writeroom-mode)
      (writeroom-mode -1)
    (writeroom-mode 1)))

;; Alternative lightweight zen mode
(defun my-zen-mode-light ()
  "Toggle lightweight zen mode with olivetti."
  (interactive)
  (if (bound-and-true-p olivetti-mode)
      (progn
        (olivetti-mode -1)
        (display-line-numbers-mode 1))
    (progn
      (olivetti-mode 1)
      (display-line-numbers-mode -1))))

;; Ultra zen mode - everything hidden
(defun my-zen-mode-ultra ()
  "Toggle ultra zen mode - hide everything."
  (interactive)
  (if (bound-and-true-p writeroom-mode)
      (progn
        (writeroom-mode -1)
        (display-line-numbers-mode 1)
        (doom-modeline-mode 1))
    (progn
      (writeroom-mode 1)
      (display-line-numbers-mode -1)
      (doom-modeline-mode -1))))

#+end_src

** Mode line
#+begin_src emacs-lisp
(use-package doom-modeline
  :ensure t
  :init (doom-modeline-mode 1)
  :config
  (setq doom-modeline-height 25
        doom-modeline-bar-width 3))
#+end_src

* Evil Mode & Keybindings
#+begin_src emacs-lisp
;; Which-key first (needed by general)
(use-package which-key
  :config
  (which-key-mode)
  (setq which-key-idle-delay 0.3))

;; Ivy - completion framework
(use-package ivy
  :ensure t
  :init
  (ivy-mode 1)
  :config
  (setq ivy-use-virtual-buffers t
        ivy-count-format "(%d/%d) "
        ivy-height 15
        ivy-wrap t
        ivy-fixed-height-minibuffer t
        enable-recursive-minibuffers t
        ivy-initial-inputs-alist nil))

;; Counsel
(use-package counsel
  :ensure t
  :after ivy
  :config
  (counsel-mode 1))

;; Swiper
(use-package swiper
  :ensure t
  :after ivy
  :bind (("C-s" . swiper)
         ("C-r" . swiper-backward)))

;; Fix seq-empty-p error (must load before Evil)
;; This ensures the seq library is properly loaded with all methods
(use-package seq
  :straight (:type built-in)
  :demand t)

;; Evil mode configuration
(use-package evil
  :after seq
  :init
  (setq evil-want-keybinding nil
        evil-want-integration t
        evil-undo-system 'undo-tree
        evil-respect-visual-line-mode t
        evil-want-C-u-scroll t
        evil-want-C-i-jump nil)
  :config
  (evil-mode 1)
  (define-key evil-insert-state-map (kbd "C-g") 'evil-normal-state)
  (define-key evil-normal-state-map (kbd "C-u") 'evil-scroll-up)
  (define-key evil-visual-state-map (kbd "C-u") 'evil-scroll-up))

(use-package evil-collection
  :after evil
  :config
  (evil-collection-init))

;; Projectile (needed before counsel-projectile)
(use-package projectile
  :config
  (projectile-mode 1)
  (setq projectile-completion-system 'ivy
        projectile-enable-caching t
        projectile-indexing-method 'alien
        projectile-sort-order 'recentf
        projectile-project-search-path '("~/git/" "~/work/" "~/Research/")
        projectile-known-projects-file (expand-file-name ".cache/projectile-bookmarks.eld" user-emacs-directory)
        projectile-cache-file (expand-file-name ".cache/projectile.cache" user-emacs-directory))
  
  (add-hook 'kill-emacs-hook #'projectile-save-known-projects)
  (add-hook 'projectile-after-switch-project-hook #'projectile-save-known-projects)
  (run-at-time nil (* 5 60) #'projectile-save-known-projects)
  
  (let ((cache-dir (expand-file-name ".cache" user-emacs-directory)))
    (unless (file-directory-p cache-dir)
      (make-directory cache-dir t))))

;; Counsel-projectile
(use-package counsel-projectile
  :ensure t
  :after (counsel projectile)
  :config
  (counsel-projectile-mode 1))

;; Ivy-rich
(use-package ivy-rich
  :ensure t
  :after ivy
  :config
  (ivy-rich-mode 1)
  (setcdr (assq t ivy-format-functions-alist) #'ivy-format-function-line))

;; General keybindings
(use-package general
  :demand t
  :config
  (general-define-key
   :prefix "SPC"
   :states '(normal visual motion)
   :keymaps 'override

   "f n" '(make-frame-command :wk "make frame")

   ;; Files & Buffers
   "f f" '(counsel-find-file :wk "Find file")
   "f s" '(save-buffer :wk "Save file")
   "f r" '(counsel-recentf :wk "Recent files")
   "b b" '(ivy-switch-buffer :wk "Switch buffer")
   "b k" '(kill-this-buffer :wk "Kill buffer")

   ;; Projects
   "p" '(:ignore t :wk "Projects")
   "p p" '(counsel-projectile-switch-project :wk "Switch project")
   "p f" '(counsel-projectile-find-file :wk "Find file in project")
   "p d" '(counsel-projectile-find-dir :wk "Find dir in project")
   "p b" '(counsel-projectile-switch-to-buffer :wk "Switch project buffer")
   "p s" '(counsel-projectile-rg :wk "Search in project")
   "p r" '(projectile-recentf :wk "Recent project files")
   "p i" '(projectile-invalidate-cache :wk "Invalidate cache")
   "p k" '(projectile-kill-buffers :wk "Kill project buffers")
   "p S" '(projectile-save-project-buffers :wk "Save project buffers")

   ;; Search
   "s" '(:ignore t :wk "Search")
   "s s" '(swiper :wk "Search buffer")
   "s p" '(counsel-projectile-rg :wk "Search project")
   "s d" '(counsel-ag :wk "Search directory")
   "s f" '(counsel-find-file :wk "Find files")
   "s g" '(counsel-git-grep :wk "Git grep")

   ;; Dashboard
   "d" '(:ignore t :wk "Dashboard")
   "d d" '(dashboard-refresh-buffer :wk "Open dashboard")
   "d p" '(dashboard-goto-projects :wk "Go to projects")
   "d r" '(dashboard-goto-recent-files :wk "Go to recent files")

   ;; Windows
   "w h" '(evil-window-left :wk "Left")
   "w j" '(evil-window-down :wk "Down")
   "w k" '(evil-window-up :wk "Up")
   "w l" '(evil-window-right :wk "Right")
   "w s" '(evil-window-split :wk "Split below")
   "w v" '(evil-window-vsplit :wk "Split right")
   "w d" '(delete-window :wk "Delete window")
   "w m" '(delete-other-windows :wk "Maximize")

   ;; Org Mode
   "o a" '(org-agenda :wk "Agenda")
   "o c" '(org-capture :wk "Capture")
   "o t" '(org-babel-tangle :wk "Tangle")

   ;; LSP
   "c" '(:ignore t :wk "LSP")
   "c r" '(lsp-rename :wk "Rename")
   "c a" '(lsp-execute-code-action :wk "Code action")
   "c f" '(lsp-format-buffer :wk "Format buffer")
   "c g" '(:ignore t :wk "Go to")
   "c g d" '(lsp-find-definition :wk "Definition")
   "c g r" '(lsp-find-references :wk "References")
   "c g i" '(lsp-find-implementation :wk "Implementation")
   "c g t" '(lsp-find-type-definition :wk "Type definition")
   "c s" '(lsp-ivy-workspace-symbol :wk "Workspace symbol")
   "c d" '(lsp-describe-thing-at-point :wk "Describe at point")
   "c e" '(lsp-treemacs-errors-list :wk "Show errors")
   "c R" '(lsp-workspace-restart :wk "Restart workspace")

   ;; Reload
   "h r r" '(my-reload-init-file :wk "Reload")

   ;; Terminal
   "t t" '(vterm :wk "Terminal")

   ;; Git
   "g g" '(magit-status :wk "Magit")

   ;; File tree
   "e" '(neotree-toggle :wk "neotree")

   ;; Typst
   "m c" '(my-typst-compile-and-view :wk "Compile & view Typst")
   "m w" '(my-typst-watch-toggle :wk "Toggle watch mode (live preview)")
   "m v" '(my-typst-view-pdf :wk "View PDF")

   ;; LaTeX Preview (any buffer)
   "l" '(:ignore t :wk "LaTeX")
   "l p" '(my-latex-preview-toggle :wk "Preview LaTeX")
   "l r" '(texfrag-document :wk "Render all (texfrag)")
   "l c" '(texfrag-clear-document :wk "Clear previews")

   ;; Help
   "h k" '(describe-key :wk "Describe key")
   "h v" '(describe-variable :wk "Describe variable")
   "h f" '(describe-function :wk "Describe function")

   ;; Buffer navigation
   "[" '(previous-buffer :wk "Previous buffer")
   "]" '(next-buffer :wk "Next buffer")

   ;; View & Zen Mode
   "v" '(:ignore t :wk "View/Zen")
   "v f" '(toggle-fullscreen :wk "Fullscreen (F11)")
   "v z" '(my-zen-mode :wk "Zen mode (writeroom)")
   "v l" '(my-zen-mode-light :wk "Zen mode light (olivetti)")
   "v u" '(my-zen-mode-ultra :wk "Ultra zen (hide all)")
   "v n" '(display-line-numbers-mode :wk "Toggle line numbers")

   ;; Other
   "SPC" '(counsel-projectile :wk "Find in project")
   "q q" '(save-buffers-kill-terminal :wk "Quit")
   "/" '(comment-line :wk "Comment")

   ;; Denote
   "n n" '(denote :wk "Denote")
   "n l" '(denote-link :wk "Denote link")
   "n L" '(denote-add-links :wk "Denote add links")))

#+end_src

* Terminal
#+begin_src emacs-lisp
(use-package vterm
  :ensure t
  :config
  (setq vterm-max-scrollback 10000
        vterm-buffer-name-string "vterm: %s"))

;; Make vterm open as a popup at the bottom
(add-to-list 'display-buffer-alist
             '("\\*vterm\\*"
               (display-buffer-at-bottom)
               (window-height . 0.3)
               (dedicated . t)))
#+end_src

* Completion & Development
#+begin_src emacs-lisp
(use-package csv-mode
  :ensure t)

;; Vertico (optional alternative to Ivy)
(use-package vertico
  :init
  (vertico-mode))

;; Persist history
(use-package savehist
  :init
  (savehist-mode))

;; Company
(use-package company
  :hook (after-init . global-company-mode)
  :config
  (setq company-idle-delay 0.2
        company-minimum-prefix-length 2
        company-tooltip-align-annotations t
        company-frontends '(company-pseudo-tooltip-frontend
                            company-echo-metadata-frontend))
  :bind (:map company-active-map
              ("C-n" . company-select-next)
              ("C-p" . company-select-previous)
              ("<tab>" . company-complete-common-or-cycle)))

;; Company-box
(use-package company-box
  :if (display-graphic-p)
  :hook (company-mode . company-box-mode)
  :config
  (setq company-box-show-single-candidate t
        company-box-doc-enable t))

;; Eldoc-box
(use-package eldoc-box
  :config
  (setq eldoc-box-max-pixel-width 800
        eldoc-box-max-pixel-height 600
        eldoc-box-clear-with-C-g t))

;; Yasnippet
(use-package yasnippet
  :hook (prog-mode . yas-minor-mode)
  :config
  (let ((snippet-dir "~/.emacs.d/snippets"))
    (when (file-directory-p snippet-dir)
      (setq yas-snippet-dirs (list snippet-dir))))
  (yas-reload-all))

(use-package yasnippet-snippets
  :after yasnippet)

;; LSP Mode - Optimized configuration
(use-package lsp-mode
  :commands (lsp lsp-deferred)
  :hook ((prog-mode . lsp-deferred)
         (lsp-mode . lsp-enable-which-key-integration))
  :init
  (setq lsp-keymap-prefix "C-c l")
  :config
  ;; Performance tuning
  (setq lsp-idle-delay 0.5
        lsp-log-io nil
        lsp-completion-provider :capf
        lsp-headerline-breadcrumb-enable nil
        lsp-enable-symbol-highlighting t
        lsp-enable-on-type-formatting nil
        lsp-signature-auto-activate t
        lsp-signature-render-documentation t
        lsp-eldoc-enable-hover t
        lsp-modeline-code-actions-enable nil
        lsp-modeline-diagnostics-enable t
        lsp-lens-enable nil
        read-process-output-max (* 1024 1024)
        gc-cons-threshold 100000000))

;; LSP UI
(use-package lsp-ui
  :after lsp-mode
  :commands lsp-ui-mode
  :hook (lsp-mode . lsp-ui-mode)
  :config
  (setq lsp-ui-doc-enable t
        lsp-ui-doc-show-with-cursor nil
        lsp-ui-doc-show-with-mouse t
        lsp-ui-doc-delay 0.5
        lsp-ui-doc-position 'at-point
        lsp-ui-doc-max-width 80
        lsp-ui-doc-max-height 30
        lsp-ui-sideline-enable t
        lsp-ui-sideline-show-diagnostics t
        lsp-ui-sideline-show-hover nil
        lsp-ui-sideline-show-code-actions t
        lsp-ui-peek-enable t
        lsp-ui-peek-show-directory t)
  :bind (:map lsp-ui-mode-map
              ([remap xref-find-definitions] . lsp-ui-peek-find-definitions)
              ([remap xref-find-references] . lsp-ui-peek-find-references)
              ("C-c l d" . lsp-ui-doc-show)))

;; LSP Ivy
(use-package lsp-ivy
  :after (lsp-mode ivy)
  :commands lsp-ivy-workspace-symbol)

;; LSP Treemacs
(use-package lsp-treemacs
  :after (lsp-mode treemacs)
  :commands lsp-treemacs-errors-list)

;; Eldoc configuration
(setq eldoc-echo-area-use-multiline-p nil
      eldoc-echo-area-prefer-doc-buffer nil)

;; Flycheck
(use-package flycheck
  :config
  (global-flycheck-mode))

;; Magit
(use-package magit
  :commands magit-status)

;; Treemacs (optional file explorer)
(use-package treemacs
  :defer t
  :config
  (setq treemacs-width 30))

(use-package treemacs-evil
  :after (treemacs evil))

(use-package treemacs-projectile
  :after (treemacs projectile))
#+end_src

* Programming Languages
#+begin_src emacs-lisp
;; Define where to fetch Tree-sitter grammars (Critical for Emacs 29+)
(setq treesit-language-source-alist
   '((typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
     (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
     (yaml "https://github.com/ikatyang/tree-sitter-yaml")
     (json "https://github.com/tree-sitter/tree-sitter-json")
     (typst "https://github.com/uben0/tree-sitter-typst")))

;; TypeScript & TSX (React)
(use-package typescript-ts-mode
  :straight (:type built-in)  ;; Prevents "RECIPE NOT FOUND" error
  :mode (("\\.ts\\'" . typescript-ts-mode)
         ("\\.tsx\\'" . tsx-ts-mode))
  :hook ((typescript-ts-mode . lsp-deferred)
         (tsx-ts-mode . lsp-deferred))
  :config
  (add-to-list 'auto-mode-alist '("\\.ts\\'" . typescript-ts-mode))
  (add-to-list 'auto-mode-alist '("\\.tsx\\'" . tsx-ts-mode)))

;; Prettier Formatting (Async - won't freeze Emacs)
(use-package apheleia
  :ensure t
  :config
  (apheleia-global-mode +1))

;; Tree-sitter (General)
(use-package tree-sitter
  :config
  (global-tree-sitter-mode))

(use-package tree-sitter-langs
  :after tree-sitter)

;; Typst support with live preview
(use-package typst-ts-mode
  :straight (:type git :host sourcehut :repo "meow_king/typst-ts-mode")
  :mode "\\.typ\\'"
  :config
  ;; Basic settings
  (setq typst-ts-mode-watch-options "--open"
        typst-ts-mode-compile-options "")

  ;; Typst helper functions
  (defvar my-typst-watch-process nil
    "Process for typst watch mode.")

  (defun my-typst-compile-and-view ()
    "Compile current Typst file and open the PDF."
    (interactive)
    (when buffer-file-name
      (let* ((input-file buffer-file-name)
             (output-file (concat (file-name-sans-extension input-file) ".pdf")))
        (save-buffer)
        (call-process "typst" nil nil nil "compile" input-file)
        (when (file-exists-p output-file)
          (if (eq system-type 'darwin)
              (call-process "open" nil nil nil output-file)
            (call-process "xdg-open" nil nil nil output-file))))))

  (defun my-typst-watch-toggle ()
    "Toggle typst watch mode for live preview."
    (interactive)
    (if (and my-typst-watch-process (process-live-p my-typst-watch-process))
        (progn
          (kill-process my-typst-watch-process)
          (setq my-typst-watch-process nil)
          (message "Typst watch mode stopped"))
      (when buffer-file-name
        (save-buffer)
        (setq my-typst-watch-process
              (start-process "typst-watch" "*typst-watch*"
                             "typst" "watch" "--open" buffer-file-name))
        (message "Typst watch mode started"))))

  (defun my-typst-view-pdf ()
    "View the PDF for the current Typst file."
    (interactive)
    (when buffer-file-name
      (let ((pdf-file (concat (file-name-sans-extension buffer-file-name) ".pdf")))
        (if (file-exists-p pdf-file)
            (if (eq system-type 'darwin)
                (call-process "open" nil nil nil pdf-file)
              (call-process "xdg-open" nil nil nil pdf-file))
          (message "PDF file not found. Compile first with SPC m c"))))))

;; Python
(use-package pyvenv
  :hook (python-mode . pyvenv-mode))

;; Rust
(use-package rustic
  :mode "\\.rs\\'"
  :config
  (setq rustic-format-on-save nil)
  (defun rustic-mode-auto-save-hook ()
    (when buffer-file-name
      (setq-local compilation-ask-about-save nil)))
  (add-hook 'rustic-mode-hook 'rustic-mode-auto-save-hook))
#+end_src

* Org Mode
#+begin_src emacs-lisp
;; Ensure nerd-icons for themes
(use-package nerd-icons
  :if (display-graphic-p)
  :ensure t)

;; Htmlize for org export
(use-package htmlize
  :ensure t)

;; Org-fragtog for LaTeX preview (simple and works great with built-in org)
(use-package org-fragtog
  :hook (org-mode . org-fragtog-mode))

(use-package org-bullets
  :ensure t)

;; Ox-typst for Typst export
(use-package ox-typst
  :ensure t
  :after org
  :config
  (setq org-typst-from-latex-environment #'org-typst-from-latex-with-naive
        org-typst-from-latex-fragment #'org-typst-from-latex-with-naive))

;; LSP support for org-mode (for code blocks)
(with-eval-after-load 'lsp-mode
  (add-hook 'org-mode-hook
            (lambda ()
              ;; Enable LSP in org-src blocks when editing them
              (add-hook 'org-src-mode-hook #'lsp-deferred nil t)))
  
  ;; Configure which languages get LSP in org src blocks
  (setq org-src-lang-modes
        '(("python" . python)
          ("rust" . rustic)
          ("elisp" . emacs-lisp)
          ("emacs-lisp" . emacs-lisp)
          ("bash" . sh)
          ("shell" . sh)
          ("sh" . sh))))


;; Org configuration
(with-eval-after-load 'org
  (setq org-directory (expand-file-name "~/org")
        org-default-notes-file (concat org-directory "/inbox.org")
        org-agenda-files (list org-directory))

  ;; Create org directory if it doesn't exist
  (unless (file-directory-p org-directory)
    (make-directory org-directory t))

  (setq org-display-inline-images t
        org-redisplay-inline-images t
        org-ellipsis " â–¼"
        org-log-done 'time
        org-hide-emphasis-markers t
        org-startup-indented t
        org-startup-folded 'content)

  
  (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1)))

  ;; TODO keywords
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "WAIT(w)" "|" "DONE(d)" "CANCELLED(c)")))

  ;; Capture templates
  (setq org-capture-templates
        '(("t" "Todo" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?\n  %i\n  %a")
          ("n" "Note" entry (file+headline org-default-notes-file "Notes")
           "* %?\n  %i\n  %a")))

  ;; LaTeX preview settings
  (setq org-latex-preview-process-default 'dvisvgm
        org-format-latex-options
        (plist-put org-format-latex-options :scale 1.5))

  ;; Source code blocks
  (setq org-src-tab-acts-natively t
        org-src-fontify-natively t
        org-src-preserve-indentation t
        org-edit-src-content-indentation 0)

  ;; Babel languages
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)
     (shell . t))))

 (setq org-babel-python-command "/opt/homebrew/bin/python3")

;; Org auto-tangle
(with-eval-after-load 'org-auto-tangle
  (add-hook 'org-mode-hook 'org-auto-tangle-mode))

;; Evil-org integration
(use-package evil-org
  :after (org evil)
  :hook (org-mode . evil-org-mode)
  :config
  (require 'evil-org-agenda)
  (evil-org-agenda-set-keys))
#+end_src

** Denote Note Taking
#+begin_src emacs-lisp
(use-package denote
  :ensure t
  :hook (dired-mode . denote-dired-mode)
  :bind
  (("C-c n n" . denote)
   ("C-c n r" . denote-rename-file)
   ("C-c n l" . denote-link)
   ("C-c n b" . denote-backlinks))
  :config
  (setq denote-directory (expand-file-name "~/Documents/notes/"))
  (denote-rename-buffer-mode 1))
#+end_src

** Ox-hugo
#+begin_src emacs-lisp
(use-package ox-hugo
  :ensure t
  :after ox)
#+end_src

** Jupyter Notebook
#+begin_src emacs-lisp
(use-package jupyter
  :ensure t
  :defer t
  :config
  (setq jupyter-server-use-environment-path t)
  
  (with-eval-after-load 'org
    (org-babel-do-load-languages
     'org-babel-load-languages
     (append org-babel-load-languages
             '((jupyter . t))))))
#+end_src

** Org-Publish
#+begin_src emacs-lisp
(with-eval-after-load 'ox-publish
  (defvar human-aug/site-root "~/Research/Portfolio/org/")
  (defvar human-aug/site-public "~/Research/Portfolio/public_html/")

  (defvar human-aug/html-head-extra
    (concat
     "<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Roboto+Mono:wght@400;500&display=swap\" rel=\"stylesheet\">\n"
     "<link rel=\"stylesheet\" type=\"text/css\" href=\"css/brand_notebook.css\" />\n"
     "<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.createElement('button');
        btn.innerText = 'ðŸŒ™/â˜€ï¸';
        btn.style.cssText = 'position:fixed;top:20px;right:20px;padding:8px 12px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:20px;cursor:pointer;color:inherit;backdrop-filter:blur(5px);z-index:1000;font-family:sans-serif;font-size:14px;transition:all 0.3s;';
        
        btn.onclick = () => {
            document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
        };
        if(localStorage.getItem('theme')==='light') document.body.classList.add('light-mode');
        document.body.appendChild(btn);

        document.querySelectorAll('pre.src').forEach(block => {
            const copy = document.createElement('button');
            copy.innerText = 'Copy';
            copy.className = 'copy-btn';
            copy.onclick = () => {
                navigator.clipboard.writeText(block.textContent);
                copy.innerText = 'Copied!';
                setTimeout(() => copy.innerText = 'Copy', 2000);
            };
            
            let container = block.parentNode;
            if (container.classList.contains('org-src-container')) {
                 container.style.position = 'relative';
                 container.appendChild(copy);
            } else {
                 block.parentNode.insertBefore(copy, block);
            }
        });
    });
   </script>"))

  (setq org-publish-project-alist
        `(("human-aug-notes"
           :base-directory ,human-aug/site-root
           :base-extension "org"
           :publishing-directory ,human-aug/site-public
           :recursive t
           :publishing-function org-html-publish-to-html
           :headline-levels 4
           :auto-preamble t
           :html-htmlize-output-type css
           :html-head-include-default-style nil
           :html-head-include-scripts nil
           :html-head-extra ,human-aug/html-head-extra
           :html-postamble nil
           :auto-sitemap t
           :sitemap-title "Human Augmentation Portfolio"
           :sitemap-filename "sitemap.org"
           :sitemap-style list
           :sitemap-sort-files anti-chronologically)

          ("human-aug-static"
           :base-directory ,human-aug/site-root
           :base-extension "css\\|js\\|pdf\\|mp3\\|ogg\\|swf"
           :publishing-directory ,human-aug/site-public
           :recursive t
           :publishing-function org-publish-attachment)

          ("human-aug-images"
           :base-directory ,human-aug/site-root
           :base-extension "png\\|jpg\\|gif\\|svg"
           :publishing-directory ,human-aug/site-public
           :recursive t
           :publishing-function org-publish-attachment)

          ("human-aug-portfolio" :components ("human-aug-notes" "human-aug-static" "human-aug-images")))))
#+end_src

** LaTeX Preview in Any Buffer

#+begin_src emacs-lisp
;; LaTeX preview in any buffer (not just org-mode)
;; This gives you org-fragtog-like experience everywhere!

;; texfrag - Inline LaTeX preview for any buffer
(use-package texfrag
  :ensure t
  :config
  ;; Enable in markdown, text, and other modes
  (add-hook 'markdown-mode-hook 'texfrag-mode)
  (add-hook 'text-mode-hook 'texfrag-mode)
  
  ;; Keybindings
  (define-key texfrag-mode-map (kbd "C-c C-x C-l") 'texfrag-document)
  
  ;; Auto-render on save (optional)
  (defun my-texfrag-auto-render ()
    "Auto-render LaTeX fragments on save."
    (when (and (bound-and-true-p texfrag-mode)
               (buffer-modified-p))
      (texfrag-document)))
  
  ;; Uncomment to enable auto-render on save:
  ;; (add-hook 'after-save-hook #'my-texfrag-auto-render)
  )

;; Alternative: math-preview (tooltip preview)
(use-package math-preview
  :ensure t
  :custom
  (math-preview-scale 1.5)  ; Scale of preview
  (math-preview-marks '(("\\(" . "\\)")   ; Inline: \( ... \)
                        ("\\[" . "\\]")   ; Display: \[ ... \]
                        ("$" . "$")       ; Inline: $ ... $
                        ("$$" . "$$")))   ; Display: $$ ... $$
  :config
  ;; Enable in various modes
  (add-hook 'markdown-mode-hook #'math-preview-mode)
  (add-hook 'text-mode-hook #'math-preview-mode)
  (add-hook 'LaTeX-mode-hook #'math-preview-mode))

;; Track texfrag preview state
(defvar-local my-texfrag-previews-active nil
  "Whether texfrag previews are currently shown.")

;; Function to toggle LaTeX preview in any buffer
(defun my-latex-preview-toggle ()
  "Toggle LaTeX preview in current buffer."
  (interactive)
  (cond
   ((derived-mode-p 'org-mode)
    ;; Use org's built-in preview for org-mode
    (if (org-latex-preview-has-fragments-p)
        (org-latex-preview '(64))  ; Clear all
      (org-latex-preview '(16)))) ; Preview all
   ((bound-and-true-p texfrag-mode)
    (if my-texfrag-previews-active
        (progn
          (texfrag-clear-document)
          (setq my-texfrag-previews-active nil)
          (message "LaTeX previews cleared"))
      (progn
        (texfrag-document)
        (setq my-texfrag-previews-active t)
        (message "LaTeX previews rendered"))))
   ((bound-and-true-p math-preview-mode)
    (math-preview-at-point))
   (t
    (message "Enable texfrag-mode or math-preview-mode first (or use in org-mode)"))))

;; Global keybinding for LaTeX preview
(global-set-key (kbd "C-c l p") 'my-latex-preview-toggle)

;; Helper function to check if org has latex fragments (for compatibility)
(unless (fboundp 'org-latex-preview-has-fragments-p)
  (defun org-latex-preview-has-fragments-p ()
    "Check if buffer has any LaTeX preview overlays."
    (let ((dominated nil))
      (dolist (ov (overlays-in (point-min) (point-max)))
        (when (overlay-get ov 'org-overlay-type)
          (setq dominated t)))
      dominated)))
#+end_src

* PDF Support
#+begin_src emacs-lisp
(use-package pdf-tools
  :magic ("%PDF" . pdf-view-mode)
  :config
  (pdf-tools-install :no-query)
  (setq-default pdf-view-display-size 'fit-width)

  (setq pdf-view-midnight-colors 
        `(,(face-foreground 'default) . ,(face-background 'default)))

  (add-hook 'pdf-view-mode-hook
            (lambda ()
              (setq pdf-view-midnight-colors
                    `(,(face-foreground 'default) . ,(face-background 'default)))
              (pdf-view-midnight-minor-mode))))
#+end_src

* Performance Optimization
#+begin_src emacs-lisp
;; Increase the amount of data Emacs reads from processes
(setq read-process-output-max (* 1024 1024)) ; 1MB

;; Reduce rendering delays
(setq redisplay-dont-pause t)

;; Improve LSP performance
(setq lsp-enable-file-watchers nil)
(setq lsp-enable-folding nil)
(setq lsp-enable-text-document-color nil)

;; Faster project indexing
(setq projectile-enable-caching t)
#+end_src
